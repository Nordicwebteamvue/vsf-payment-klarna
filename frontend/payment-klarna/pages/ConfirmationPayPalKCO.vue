<template>
  <div class="container">
    <div class="confirmation my15" v-show="showBlock">
      <div class="header">
        <!-- eslint-disable-next-line -->
        <svg height="100" width="100"><g fill="none" fill-rule="evenodd" transform="translate(0, 0) scale(1)"><path d="M7.5625,76.439 C6.9765,75.853 6.0275,75.853 5.4415,76.439 L4.0005,77.879 L2.5605,76.439 C1.9745,75.853 1.0255,75.853 0.4395,76.439 C-0.1465,77.025 -0.1465,77.975 0.4395,78.56 L1.8795,80 L0.4395,81.44 C-0.1465,82.025 -0.1465,82.975 0.4395,83.561 C0.7325,83.854 1.1165,84.001 1.5005,84.001 C1.8835,84.001 2.2675,83.854 2.5605,83.561 L4.0005,82.121 L5.4415,83.561 C5.7345,83.854 6.1185,84.001 6.5015,84.001 C6.8855,84.001 7.2695,83.854 7.5625,83.561 C8.1485,82.975 8.1485,82.025 7.5625,81.44 L6.1225,80 L7.5625,78.56 C8.1485,77.975 8.1485,77.025 7.5625,76.439" fill="rgba(52, 52, 52, 1)"></path><path d="M77.5,6.5 L79.5,6.5 L79.5,8.5 C79.5,9.329 80.172,10 81,10 C81.828,10 82.5,9.329 82.5,8.5 L82.5,6.5 L84.5,6.5 C85.328,6.5 86,5.829 86,5 C86,4.171 85.328,3.5 84.5,3.5 L82.5,3.5 L82.5,1.5 C82.5,0.671 81.828,0 81,0 C80.172,0 79.5,0.671 79.5,1.5 L79.5,3.5 L77.5,3.5 C76.672,3.5 76,4.171 76,5 C76,5.829 76.672,6.5 77.5,6.5" fill="rgba(52, 52, 52, 1)"></path><path d="M71.2773,37.2163 C70.5693,36.7883 69.6453,37.0143 69.2173,37.7243 L50.5553,68.5933 C50.2423,68.9333 49.8593,68.9943 49.6533,68.9993 C49.4333,69.0063 49.0133,68.9583 48.6843,68.5933 L37.6283,55.9963 C37.0843,55.3743 36.1333,55.3113 35.5113,55.8583 C34.8883,56.4043 34.8273,57.3523 35.3743,57.9753 L46.4443,70.5883 C47.2573,71.4893 48.4093,72.0003 49.6203,72.0003 C49.6563,72.0003 49.6923,71.9993 49.7293,71.9983 C50.9783,71.9663 52.1483,71.3923 52.9383,70.4233 C52.9823,70.3683 53.0223,70.3113 53.0583,70.2513 L71.7843,39.2763 C72.2133,38.5673 71.9863,37.6453 71.2773,37.2163" fill="rgba(52, 52, 52, 1)"></path><path d="M15.5,93 C14.119,93 13,94.119 13,95.5 C13,96.881 14.119,98 15.5,98 C16.881,98 18,96.881 18,95.5 C18,94.119 16.881,93 15.5,93" fill="rgba(52, 52, 52, 1)"></path><path d="M95.5,19 C94.119,19 93,20.119 93,21.5 C93,22.881 94.119,24 95.5,24 C96.881,24 98,22.881 98,21.5 C98,20.119 96.881,19 95.5,19" fill="rgba(52, 52, 52, 1)"></path><path d="M80.5015584,94.7095656 C78.7737321,91.403919 76.2839824,88.5432249 73.2802844,86.3604582 C73.155297,86.2424708 73.016311,86.1444813 72.8623265,86.0764886 C72.0384093,85.5035498 71.186495,84.968607 70.2925849,84.5016569 C74.6421475,82.2279 78.2287869,78.6412835 80.5015584,74.2927484 C81.4114669,76.0335623 82.5403534,77.64539 83.8362231,79.1062338 C83.9342132,79.2582175 84.0572008,79.3922032 84.2021863,79.5011916 C86.0689986,81.5149763 88.262778,83.2217938 90.7105319,84.5016569 C86.3609692,86.774414 82.7743298,90.3610305 80.5015584,94.7095656 M68.1917961,89.3701365 L68.013814,89.6461069 C65.9600205,92.8217674 61.8794308,93.9176503 58.5107695,92.1928347 L58.2157992,92.0418508 C55.2660958,90.5310123 51.74345,90.5310123 48.7917467,92.0428507 L48.4987762,92.1928347 C45.1341145,93.9156505 41.0465255,92.8227673 38.9947318,89.6471068 L38.8167497,89.3691366 C37.0169307,86.5854342 33.9662374,84.8236225 30.6525706,84.6566404 L30.3246036,84.6406421 C26.5479833,84.4506624 23.557284,81.4599821 23.3673031,77.682386 L23.3513048,77.3544211 C23.1853214,74.0427751 21.4234986,70.9921013 18.6417783,69.1932936 L18.3628063,69.0133128 C15.1871257,66.9615322 14.0922357,62.8749691 15.8160624,59.5093289 L15.9660473,59.2163602 C17.4778953,56.2656757 17.4778953,52.7430523 15.9660473,49.7923678 L15.8160624,49.4993991 C14.0922357,46.1337589 15.1871257,42.0481957 18.3648061,39.9944153 L18.6397785,39.8164343 C21.4234986,38.0166267 23.1853214,34.9659529 23.3513048,31.6553068 L23.3673031,31.3253421 C23.557284,27.5487459 26.5479833,24.5580656 30.3226038,24.3680859 L30.6545704,24.3520876 C33.9662374,24.1851055 37.0169307,22.4242937 38.8167497,19.6385915 L38.9947318,19.3636209 C41.0495252,16.1879604 45.1311148,15.0930775 48.4977763,16.8158933 L48.7927466,16.9668772 C51.7424501,18.4787155 55.2650959,18.4787155 58.2167991,16.9668772 L58.5097696,16.8158933 C61.8734314,15.0920776 65.9610204,16.1859607 68.013814,19.362621 L68.1917961,19.6395914 C69.9916151,22.4242937 73.0423084,24.1851055 76.3559752,24.3520876 L76.6839422,24.3680859 C80.4605625,24.5580656 83.4512618,27.5487459 83.6412427,31.326342 L83.6572411,31.6543069 C83.8232244,34.9659529 85.5850472,38.0166267 88.3667675,39.8154344 L88.6457395,39.9954152 C91.8214202,42.0481957 92.9163101,46.1337589 91.1924834,49.4993991 L91.0424985,49.7923678 C89.5306505,52.7430523 89.5306505,56.2656757 91.0424985,59.2163602 L91.1924834,59.5093289 C92.9163101,62.8749691 91.8214202,66.9615322 88.6437397,69.0143127 L88.3687673,69.1922937 C86.3719681,70.4831557 84.9141147,72.4219484 84.1811884,74.6347118 C83.2482822,73.2028649 82.4803594,71.6560303 81.9214156,70.0182054 C81.7134365,69.4112703 81.1434938,69.0033139 80.5015584,69.0033139 C79.8596229,69.0033139 79.2896802,69.4112703 79.0817011,70.0182054 C76.9999104,76.1155535 72.1154016,80.9990314 66.0190146,83.0818087 C65.4110757,83.2897865 65.0031167,83.8597256 65.0031167,84.5016569 C65.0031167,85.1425884 65.4110757,85.7125275 66.0190146,85.9205053 C67.2908867,86.3554588 68.5057645,86.9183986 69.6576487,87.5823276 C69.1047043,88.12127 68.610754,88.7222057 68.1917961,89.3701365 M94.9841021,83.0818087 C91.793423,81.9919253 88.9397099,80.1291244 86.6419409,77.7323807 L86.6529398,77.504405 C86.7719279,75.1546562 88.0218022,72.9888878 89.9996033,71.7110244 L90.2735758,71.5330434 C94.7491258,68.6413526 96.2919706,62.8839681 93.862215,58.1414751 L93.71223,57.8485065 C92.6393379,55.7547303 92.6393379,53.2549976 93.71223,51.1602215 L93.862215,50.8662529 C96.2919706,46.1247599 94.7491258,40.3673754 90.2755756,37.4766844 L89.9976035,37.2967037 C88.0218022,36.0198402 86.7719279,33.8540717 86.6529398,31.504323 L86.6369414,31.1753581 C86.3689684,25.853927 82.1553921,21.6393776 76.8319273,21.3724062 L76.5039603,21.3564079 C74.1541966,21.2384205 71.9884143,19.9875542 70.7115427,18.0117655 L70.5325607,17.7347951 C67.6408515,13.2602734 61.8834304,11.7154386 57.1419071,14.1471786 L56.8489366,14.2971626 C54.7531473,15.369048 52.2543986,15.369048 50.1606091,14.2981625 L49.8656388,14.1461787 C45.1271152,11.7174384 39.3686942,13.2602734 36.4759851,17.735795 L36.2970031,18.0107656 C35.0201315,19.9875542 32.8543492,21.2384205 30.5065853,21.3564079 L30.1746187,21.3724062 C24.8531537,21.6393776 20.6395774,25.853927 20.3716044,31.1743582 L20.355606,31.504323 C20.2366179,33.8540717 18.9867436,36.0198402 17.0089425,37.2977036 L16.73497,37.4756846 C12.25942,40.3673754 10.7165752,46.1247599 13.1463309,50.8672528 L13.2963158,51.1602215 C14.3692079,53.2549976 14.3692079,55.7547303 13.2963158,57.8485065 L13.1463309,58.142475 C10.7165752,62.8839681 12.25942,68.6413526 16.7329702,71.5320435 L17.0109423,71.7120243 C18.9867436,72.9888878 20.2366179,75.1546562 20.355606,77.504405 L20.3716044,77.8333699 C20.6395774,83.1548009 24.8531537,87.3693504 30.1766185,87.6363218 L30.5045855,87.6523201 C32.8543492,87.7713074 35.0201315,89.0211738 36.2970031,90.9969625 L36.4759851,91.2739329 C39.3676943,95.7474546 45.1221157,97.2912896 49.8666387,94.8615494 L50.1596092,94.7115654 C52.2553985,93.63968 54.7541472,93.63968 56.8479367,94.7105655 L57.142907,94.8625493 C58.654755,95.6374664 60.2725924,96.0084267 61.8654322,96.0084267 C65.2660903,96.0084267 68.5637587,94.3206072 70.5325607,91.272933 L70.7115427,90.9979624 C71.1215015,90.3630303 71.6384495,89.7970908 72.2233907,89.3161422 C75.3540759,91.7958771 77.7728327,95.1495186 79.0817011,98.9841086 C79.2896802,99.5910437 79.8596229,99.9990001 80.5015584,100 C81.1434938,100 81.7134365,99.5910437 81.9214156,98.9841086 C84.0032063,92.8867605 88.8877151,88.0032826 94.9841021,85.9205053 C95.592041,85.7125275 96,85.1425884 96,84.5016569 C96,83.8597256 95.592041,83.2897865 94.9841021,83.0818087" fill="rgba(52, 52, 52, 1)"></path><path d="M19,4.9131 C20.054,6.5481 21.452,7.9461 23.087,9.0001 C21.452,10.0541 20.054,11.4521 19,13.0861 C17.946,11.4521 16.548,10.0541 14.913,9.0001 C16.548,7.9461 17.946,6.5481 19,4.9131 M17.58,16.9841 C17.788,17.5911 18.358,17.9991 19,17.9991 C19.642,17.9991 20.212,17.5911 20.42,16.9841 C21.466,13.9201 23.92,11.4661 26.984,10.4191 C27.592,10.2121 28,9.6421 28,9.0001 C28,8.3581 27.592,7.7881 26.984,7.5801 C23.92,6.5341 21.466,4.0801 20.42,1.0151 C20.212,0.4081 19.642,0.0001 19,0.0001 C18.358,0.0001 17.788,0.4091 17.58,1.0161 C16.534,4.0801 14.08,6.5341 11.016,7.5801 C10.408,7.7881 10,8.3581 10,9.0001 C10,9.6421 10.408,10.2121 11.016,10.4191 C14.08,11.4661 16.534,13.9201 17.58,16.9841" fill="rgba(52, 52, 52, 1)"></path></g></svg>
        <div class="title mt15">
          <p>{{ i18n.t('Thank you, your order has been purchased completed.') }}</p>
          <p>{{ message }}</p>
        </div>
      </div>
      <div class="content-detail">
        <h4>{{ i18n.t('Items Purchased') }}</h4>
        <div class="items">
          <!-- eslint-disable-next-line -->
          <div class="item-detail my10" v-for="item in order.items">
            <div>{{ item.label }}</div>
            <div>{{ item.price }}</div>
          </div>
        </div>
      </div>
      <div class="content-detail">
        <h4>{{ i18n.t('Order Detail') }}</h4>
        <div class="total my10 py10">
          <div>
            {{ i18n.t('Total') }}
          </div>
          <div>
            {{ order.total }}
          </div>
        </div>
        <div class="line"/>
        <div class="payment my10 py10">
          <div>
            {{ i18n.t('Paid By') }}
          </div>
          <div>
            <img width="75" :src="order.image_url">
          </div>
        </div>
      </div>
      <div class="content-detail">
        <h4>{{ i18n.t('Shipping Detail') }}</h4>
        <div class="shipping my10 py10">
          <div>
            {{ i18n.t('Address Line 1') }}
          </div>
          <div>
            {{ order.shipping.line1 }}
          </div>
        </div>
        <div class="shipping my10 py10" v-show="order.shipping.line2">
          <div>
            {{ i18n.t('Address Line 2') }}
          </div>
          <div>
            {{ order.shipping.line2 }}
          </div>
        </div>
        <div class="shipping my10 py10">
          <div>
            {{ i18n.t('State') }}
          </div>
          <div>
            {{ order.shipping.state }}
          </div>
        </div>
        <div class="shipping my10 py10">
          <div>
            {{ i18n.t('City') }}
          </div>
          <div>
            {{ order.shipping.city }}
          </div>
        </div>
        <div class="shipping my10 py10">
          <div>
            {{ i18n.t('Zip code') }}
          </div>
          <div>
            {{ order.shipping.postal_code }}
          </div>
        </div>
        <div class="shipping my10 py10">
          <div>
            {{ i18n.t('Country Code') }}
          </div>
          <div>
            {{ order.shipping.country_code }}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<style lang="scss" scoped>
  .container
  {
    display: flex;
    justify-content: center;
    height: 1000px;
    align-items: center;
    .title
    {
      text-align: center;
    }
    .header
    {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .line
    {
      border-bottom-color: rgb(233, 233, 232);
      border-style: solid;
      border-width: 1px 0px 0px;
    }
    .total, .payment, .item-detail, .shipping
    {
      display: flex;
      justify-content: space-between;
    }
  }
  .confirmation {
    min-height: 100px;
  }
</style>

<script>
import config from 'config'
import { currentStoreView } from '@vue-storefront/core/lib/multistore'
import paypal from 'paypal-rest-sdk-kodbruket-fixed'
import i18n from '@vue-storefront/i18n'

export default {
  name: 'PaypalConfirmationKCO',
  data () {
    const storeView = currentStoreView()
    return {
      loader: false,
      commit: true,
      currency: storeView.i18n.currencyCode,
      showBlock: false,
      message: null,
      order: {
        total: null,
        image_url: null,
        items: [
          {
            label: null,
            price: null
          }
        ],
        shipping: {
          line1: null,
          line2: null,
          city: null,
          post_code: null,
          country_code: null,
          state: null
        }
      },
      locale: storeView.i18n.defaultLocale.replace('-', '_') // Convert to PayPal format of locale
    }
  },
  beforeCreate () {
    this.i18n = i18n
  },
  mounted () {
    // Build PayPal payment reques
    this.$Progress.start()
    this.checkConfirmPayPal()
  },
  methods: {
    checkConfirmPayPal () {
      paypal.configure({
        mode: config.paypal.env, // Sandbox or live
        client_id: config.paypal.client,
        client_secret: config.paypal.secret
      })
      var paymentId = this.$route.query.paymentId
      paypal.payment.get(paymentId, (error, payment) => {
        if (error) {
          console.log(error)
          this.$Progress.fail()
          window.location = config.paypal.cancel_url
          throw error
        } else {
          this.order.total = payment.transactions[0].amount.total + ' ' + payment.transactions[0].amount.currency
          this.order.image_url = config.paypal.image_url
          let items = payment.transactions[0].item_list.items.map((item) => {
            return {
              sku: item.sku,
              qty: item.quantity,
              name: item.name,
              price: item.price
            }
          })
          this.order.products = items
          this.order.shipping = payment.transactions[0].item_list.shipping_address
          this.showBlock = true
          this.message = i18n.t('Once your order has been processed, a payment confirmation will be sent to') + ' ' + payment.payer.payer_info.email
          // this.$bus.$emit('checkout-do-placeOrder', payment)
          // this.$store.dispatch('checkout/placeOrder', { order: this.order })
          this.$Progress.finish()
        }
      })
    }
  }
}
</script>
